#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¸Šä¸‹æ–‡æ„é€ å™¨ - æ„å»ºæ–°çš„XMLç»“æ„åŒ–ä¸Šä¸‹æ–‡
"""

from typing import Dict, List, Optional
import json


class ContextBuilder:
    """æ„å»ºXMLç»“æ„åŒ–çš„Agentä¸Šä¸‹æ–‡ï¼ˆå®Œæ•´ï¼‰"""
    
    def __init__(self, hierarchy_manager, agent_config: Dict, config_loader, llm_client=None, max_context_window=100000):
        """
        åˆå§‹åŒ–ä¸Šä¸‹æ–‡æ„é€ å™¨
        
        Args:
            hierarchy_manager: å±‚çº§ç®¡ç†å™¨å®ä¾‹
            agent_config: Agenté…ç½®ï¼ˆåŒ…å«promptsï¼‰
            config_loader: é…ç½®åŠ è½½å™¨ï¼ˆç”¨äºè¯»å–general_promptsï¼‰
            llm_client: LLMå®¢æˆ·ç«¯ï¼ˆç”¨äºå‹ç¼©æ€»ç»“ï¼‰
            max_context_window: æœ€å¤§ä¸Šä¸‹æ–‡çª—å£
        """
        self.hierarchy_manager = hierarchy_manager
        self.agent_config = agent_config
        self.config_loader = config_loader
        self.current_action_history = []  # å½“å‰Agentçš„åŠ¨ä½œå†å²ï¼ˆä»å¤–éƒ¨ä¼ å…¥ï¼‰
        self.llm_client = llm_client
        self.max_context_window = max_context_window
        
        # åˆå§‹åŒ–tiktoken
        try:
            import tiktoken
            self.encoding = tiktoken.get_encoding("cl100k_base")
        except ImportError:
            self.encoding = None
    
    def build_context(self, task_id: str, agent_id: str, agent_name: str, task_input: str, 
                     action_history: List[Dict] = None) -> str:
        """
        æ„å»ºå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«é€šç”¨éƒ¨åˆ†+åŠ¨æ€ä¸Šä¸‹æ–‡ï¼‰
        
        Args:
            task_id: ä»»åŠ¡IDï¼ˆç”¨äºè¯»å–æ–‡ä»¶ï¼‰
            agent_id: å½“å‰Agent ID
            agent_name: å½“å‰Agentåç§°
            task_input: å½“å‰Agentçš„ä»»åŠ¡è¾“å…¥
            action_history: å½“å‰Agentçš„åŠ¨ä½œå†å²ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆä½¿ç”¨ï¼‰
            
        Returns:
            å®Œæ•´çš„XMLç»“æ„åŒ–ä¸Šä¸‹æ–‡å­—ç¬¦ä¸²ï¼ˆåŒ…å«é€šç”¨æç¤ºè¯ï¼‰
        """
        context_data = self.hierarchy_manager.get_context()
        current = context_data.get("current", {})
        history = context_data.get("history", [])
        
        # ä½¿ç”¨ä¼ å…¥çš„action_history
        if action_history is not None:
            self.current_action_history = action_history
        
        # 1ï¸âƒ£ è¯»å–é€šç”¨ç³»ç»Ÿæç¤ºè¯ï¼ˆgeneral_prompts.yamlï¼ŒåŒ…å«<æ™ºèƒ½ä½“ç»éªŒ>ï¼‰
        general_system_prompt = self._load_general_system_prompt(agent_name)
        
        # 2ï¸âƒ£ æ„å»ºå„ä¸ªåŠ¨æ€éƒ¨åˆ†
        user_latest_input = self._build_user_latest_input(current)
        user_agent_history = self._build_user_agent_history(history)
        structured_call_info = self._build_structured_call_info(current, agent_id)
        current_thinking = self._build_current_thinking(task_id, agent_id, current)
        action_history_xml = self._build_action_history(task_id, agent_id)
        
        # 3ï¸âƒ£ ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆé€šç”¨éƒ¨åˆ†åœ¨æœ€å‰é¢ï¼‰
        full_context = f"""{general_system_prompt}

<ç”¨æˆ·æœ€æ–°è¾“å…¥>
{user_latest_input}
</ç”¨æˆ·æœ€æ–°è¾“å…¥>

<ç”¨æˆ·-æ™ºèƒ½ä½“å†å²äº¤äº’>
{user_agent_history}
</ç”¨æˆ·-æ™ºèƒ½ä½“å†å²äº¤äº’>

<å½“å‰è¿è¡Œæ™ºèƒ½ä½“åç§°>
{agent_name}
</å½“å‰è¿è¡Œæ™ºèƒ½ä½“åç§°>

<ç»“æ„åŒ–è°ƒç”¨ä¿¡æ¯>
{structured_call_info}
</ç»“æ„åŒ–è°ƒç”¨ä¿¡æ¯>

<å½“å‰æ™ºèƒ½ä½“ä»»åŠ¡>
{task_input}
</å½“å‰æ™ºèƒ½ä½“ä»»åŠ¡>

<å½“å‰è¿›åº¦æ€è€ƒ>
{current_thinking}
</å½“å‰è¿›åº¦æ€è€ƒ>

<å†å²åŠ¨ä½œ>
{action_history_xml}
</å†å²åŠ¨ä½œ>
"""
        
        return full_context
    
    def _load_general_system_prompt(self, agent_name: str) -> str:
        """
        è¯»å–å¹¶æ ¼å¼åŒ–é€šç”¨ç³»ç»Ÿæç¤ºè¯ï¼ˆåŒ…å«<æ™ºèƒ½ä½“ç»éªŒ>ï¼‰
        
        Args:
            agent_name: Agentåç§°
            
        Returns:
            æ ¼å¼åŒ–åçš„é€šç”¨ç³»ç»Ÿæç¤ºè¯ï¼ˆXMLæ ¼å¼ï¼‰
        """
        # è¯»å–general_prompts.yaml
        import yaml
        from pathlib import Path
        
        agent_system_name = self.config_loader.agent_system_name
        prompts_file = Path(self.config_loader.config_root) / "agent_library" / agent_system_name / "general_prompts.yaml"
        
        if not prompts_file.exists():
            return ""
        
        with open(prompts_file, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f)
            system_prompt_xml = data.get("system_prompt_xml", "")
        
        # æ ¼å¼åŒ–å˜é‡
        prompts = self.agent_config.get("prompts", {})
        agent_responsibility = prompts.get("agent_responsibility", "å®Œæˆåˆ†é…çš„ä»»åŠ¡")
        agent_workflow = prompts.get("agent_workflow", "(æ— ç‰¹å®šæµç¨‹)")
        
        return system_prompt_xml.format(
            agent_name=agent_name,
            agent_responsibility=agent_responsibility,
            agent_workflow=agent_workflow
        )
    
    def _build_user_latest_input(self, current: Dict) -> str:
        """æ„å»ºç”¨æˆ·æœ€æ–°è¾“å…¥éƒ¨åˆ†"""
        instructions = current.get("instructions", [])
        if not instructions:
            return "(æ— )"
        
        # è¿”å›æ‰€æœ‰æŒ‡ä»¤ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰
        result = []
        for i, instr in enumerate(instructions, 1):
            instruction_text = instr.get("instruction", "")
            start_time = instr.get("start_time", "")
            result.append(f"{i}. {instruction_text} (å¼€å§‹æ—¶é—´: {start_time})")
        
        return "\n".join(result)
    
    def _build_user_agent_history(self, history: List[Dict]) -> str:
        """
        æ„å»ºç”¨æˆ·-æ™ºèƒ½ä½“å†å²äº¤äº’éƒ¨åˆ†
        å±•ç¤ºå†å²ä»»åŠ¡ä¸­Level 0 Agentçš„progress
        """
        if not history:
            return "(æ— å†å²äº¤äº’)"
        
        result = []
        for i, hist_item in enumerate(history, 1):
            instructions = hist_item.get("instructions", [])
            agents_status = hist_item.get("agents_status", {})
            start_time = hist_item.get("start_time", "")
            completion_time = hist_item.get("completion_time", "")
            
            result.append(f"\n=== å†å²ä»»åŠ¡ {i} ===")
            result.append(f"æ—¶é—´: {start_time} â†’ {completion_time}")
            
            # æ˜¾ç¤ºæŒ‡ä»¤
            if instructions:
                result.append("\nç”¨æˆ·æŒ‡ä»¤:")
                for instr in instructions:
                    result.append(f"  - {instr.get('instruction', '')}")
            
            # æ˜¾ç¤ºLevel 0 Agentçš„final_outputï¼ˆå·²å®Œæˆï¼‰æˆ–latest_thinkingï¼ˆè¿›è¡Œä¸­ï¼‰
            level_0_agents = [
                (aid, info) for aid, info in agents_status.items()
                if info.get("level") == 0 and info.get("agent_name") != "judge_agent"
            ]
            
            if level_0_agents:
                result.append("\nLevel 0 Agentæ‰§è¡Œç»“æœ:")
                for aid, info in level_0_agents:
                    agent_name = info.get("agent_name", "")
                    status = info.get("status", "")
                    
                    # ä¼˜å…ˆæ˜¾ç¤ºfinal_outputï¼ˆå¦‚æœå·²å®Œæˆï¼‰
                    if status == "completed" and "final_output" in info:
                        final_output = info.get("final_output", "")
                        result.append(f"  ã€{agent_name}ã€‘ï¼ˆå·²å®Œæˆï¼‰")
                        result.append(f"  {final_output}")
                    elif "latest_thinking" in info:
                        # å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºthinking
                        thinking = info.get("latest_thinking", "")
                        result.append(f"  ã€{agent_name}ã€‘ï¼ˆè¿è¡Œä¸­ï¼‰")
                        result.append(f"  {thinking}")
                    else:
                        result.append(f"  ã€{agent_name}ã€‘")
                        result.append(f"  (æ— è¾“å‡ºä¿¡æ¯)")
        
        return "\n".join(result)
    
    def _build_structured_call_info(self, current: Dict, current_agent_id: str) -> str:
        """æ„å»ºç»“æ„åŒ–è°ƒç”¨ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼Œæ›´æ¸…æ™°ï¼‰"""
        hierarchy = current.get("hierarchy", {})
        agents_status = current.get("agents_status", {})
        
        if not agents_status:
            return "(æ— è°ƒç”¨å…³ç³»)"
        
        # æ‰¾åˆ°æ ¹Agentï¼ˆLevel 0ï¼‰
        root_agents = [
            aid for aid, info in hierarchy.items()
            if info.get("parent") is None
        ]
        
        if not root_agents:
            return "(æ— è°ƒç”¨å…³ç³»)"
        
        # æ„å»ºJSONç»“æ„ï¼ˆæ·»åŠ å·²è®¿é—®é›†åˆé˜²æ­¢å¾ªç¯ï¼‰
        call_tree = []
        visited = set()  # é˜²æ­¢å¾ªç¯å¼•ç”¨
        for root_id in root_agents:
            tree_node = self._build_agent_tree_json(
                root_id, hierarchy, agents_status, current_agent_id, visited
            )
            if tree_node:
                call_tree.append(tree_node)
        
        # è½¬æ¢ä¸ºæ˜“è¯»çš„JSONå­—ç¬¦ä¸²
        return json.dumps(call_tree, indent=2, ensure_ascii=False)
    
    def _build_agent_tree_json(
        self,
        agent_id: str,
        hierarchy: Dict,
        agents_status: Dict,
        current_agent_id: str,
        visited: set = None
    ) -> Dict:
        """é€’å½’æ„å»ºAgentæ ‘çš„JSONç»“æ„ï¼ˆå¸¦å¾ªç¯æ£€æµ‹ï¼‰"""
        # åˆå§‹åŒ–visitedé›†åˆ
        if visited is None:
            visited = set()
        
        # æ£€æŸ¥æ˜¯å¦å·²è®¿é—®ï¼ˆé˜²æ­¢å¾ªç¯ï¼‰
        if agent_id in visited:
            return None
        
        visited.add(agent_id)
        
        if agent_id not in agents_status:
            return None
        
        agent_info = agents_status[agent_id]
        agent_name = agent_info.get("agent_name", "")
        
        # å®Œå…¨è·³è¿‡judge_agentï¼ˆä¸æ˜¾ç¤ºä¹Ÿä¸å¤„ç†ï¼‰
        if agent_name == "judge_agent":
            return None
        
        level = agent_info.get("level", 0)
        status = agent_info.get("status", "")
        is_current = (agent_id == current_agent_id)
        
        # æ„å»ºèŠ‚ç‚¹æ•°æ®
        node = {
            "agent_id": agent_id,
            "agent_name": agent_name,
            "level": level,
            "status": status,
            "is_current": is_current
        }
        
        # æ·»åŠ thinkingæˆ–final_output
        if status == "completed":
            final_output = agent_info.get("final_output", "")
            if final_output:
                # é™åˆ¶é•¿åº¦
                node["final_output"] = final_output[:500] + "..." if len(final_output) > 500 else final_output
        else:
            thinking = agent_info.get("latest_thinking", "")
            if thinking:
                # é™åˆ¶é•¿åº¦
                node["thinking"] = thinking[:500] + "..." if len(thinking) > 500 else thinking
        
        # é€’å½’å¤„ç†å­èŠ‚ç‚¹
        children = hierarchy.get(agent_id, {}).get("children", [])
        if children:
            child_nodes = []
            for child_id in children:
                child_node = self._build_agent_tree_json(
                    child_id, hierarchy, agents_status, current_agent_id, visited
                )
                if child_node:
                    if isinstance(child_node, list):
                        child_nodes.extend(child_node)
                    else:
                        child_nodes.append(child_node)
            
            if child_nodes:
                node["children"] = child_nodes
        
        return node
    
    def _format_agent_tree(
        self, 
        agent_id: str, 
        hierarchy: Dict, 
        agents_status: Dict, 
        indent: int,
        current_agent_id: str
    ) -> str:
        """é€’å½’æ ¼å¼åŒ–Agentæ ‘ï¼ˆæ¸…æ™°å±•ç¤ºå±‚çº§å’ŒçŠ¶æ€ï¼‰"""
        if agent_id not in agents_status:
            return ""
        
        agent_info = agents_status[agent_id]
        agent_name = agent_info.get("agent_name", "")
        
        # è·³è¿‡judge_agentçš„æ˜¾ç¤ºï¼ˆé¿å…å¹²æ‰°ï¼‰
        if agent_name == "judge_agent":
            # ä½†ä»éœ€é€’å½’å¤„ç†å®ƒçš„å­èŠ‚ç‚¹
            children = hierarchy.get(agent_id, {}).get("children", [])
            child_lines = []
            for child_id in children:
                child_tree = self._format_agent_tree(
                    child_id, hierarchy, agents_status, indent, current_agent_id
                )
                if child_tree:
                    child_lines.append(child_tree)
            return "\n".join(child_lines)
        
        level = agent_info.get("level", 0)
        status = agent_info.get("status", "")
        
        # å½“å‰Agentæ ‡è®°
        current_marker = " [å½“å‰Agent]" if agent_id == current_agent_id else ""
        
        # çŠ¶æ€å›¾æ ‡
        status_icon = "âœ…" if status == "completed" else "â³"
        
        # ç¼©è¿›
        indent_str = "  " * indent
        
        # æ„å»ºè¾“å‡º
        lines = []
        
        # ç¬¬ä¸€è¡Œï¼šAgent IDå’Œåç§°
        lines.append(f"{indent_str}{status_icon} {agent_id} ({agent_name}, Level {level}){current_marker}")
        
        # ç¬¬äºŒè¡Œï¼šçŠ¶æ€ä¿¡æ¯
        if status == "completed":
            # å·²å®Œæˆï¼šæ˜¾ç¤ºfinal_output
            final_output = agent_info.get("final_output", "")
            if final_output:
                # é™åˆ¶è¾“å‡ºé•¿åº¦
                output_preview = final_output[:300] + "..." if len(final_output) > 300 else final_output
                lines.append(f"{indent_str}  ğŸ“Š Final Output: {output_preview}")
        else:
            # è¿è¡Œä¸­ï¼šæ˜¾ç¤ºlatest_thinking
            thinking = agent_info.get("latest_thinking", "")
            if thinking:
                # é™åˆ¶thinkingé•¿åº¦
                thinking_preview = thinking[:300] + "..." if len(thinking) > 300 else thinking
                lines.append(f"{indent_str}  ğŸ’­ Thinking: {thinking_preview}")
        
        # é€’å½’å¤„ç†å­Agent
        children = hierarchy.get(agent_id, {}).get("children", [])
        for child_id in children:
            child_tree = self._format_agent_tree(
                child_id, hierarchy, agents_status, indent + 1, current_agent_id
            )
            if child_tree:  # åªæ·»åŠ éç©ºçš„å­æ ‘
                lines.append(child_tree)
        
        return "\n".join(lines)
    
    def _build_current_thinking(self, task_id: str, agent_id: str, current: Dict) -> str:
        """æ„å»ºå½“å‰è¿›åº¦æ€è€ƒï¼ˆä»æ–‡ä»¶è¯»å–æœ€æ–°çš„thinkingï¼‰"""
        # âœ… ä»_actions.jsonæ–‡ä»¶è¯»å–
        from pathlib import Path
        import json
        
        filepath = Path(__file__).parent.parent / "conversations" / f"{task_id}_{agent_id}_actions.json"
        
        try:
            if filepath.exists():
                with open(filepath, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    thinking = data.get("latest_thinking", "")
                    if thinking:
                        return thinking
        except Exception as e:
            print(f"âš ï¸ è¯»å–thinkingå¤±è´¥: {e}")
        
        # å¤‡ç”¨ï¼šä»share_contextè¯»å–
        agents_status = current.get("agents_status", {})
        if agent_id in agents_status:
            thinking = agents_status[agent_id].get("latest_thinking", "")
            if thinking:
                return thinking
        
        return "(æ— )"
    
    def _build_action_history(self, task_id: str, agent_id: str) -> str:
        """æ„å»ºå†å²åŠ¨ä½œè®°å½•ï¼ˆä»æ–‡ä»¶è¯»å–ï¼ŒXMLæ ¼å¼ï¼‰"""
        # âœ… ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„action_history
        action_history = self.current_action_history
        
        # å¦‚æœæ²¡æœ‰ä¼ å…¥ï¼Œä»æ–‡ä»¶è¯»å–
        if not action_history:
            from pathlib import Path
            import json
            
            filepath = Path(__file__).parent.parent / "conversations" / f"{task_id}_{agent_id}_actions.json"
            
            try:
                if filepath.exists():
                    with open(filepath, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        action_history = data.get("action_history", [])
            except Exception as e:
                print(f"âš ï¸ è¯»å–action_historyå¤±è´¥: {e}")
        
        if not action_history:
            return "(æ— å†å²åŠ¨ä½œ)"
        
        # æ„å»ºXMLæ ¼å¼çš„åŠ¨ä½œå†å²
        actions_xml = []
        for action in action_history:
            tool_name = action.get("tool_name", "")
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å†å²æ€»ç»“
            if tool_name == "_historical_summary":
                # æ¸²æŸ“ä¸º<å·²å‹ç¼©ä¿¡æ¯>
                summary_text = action.get("result", {}).get("output", "")
                actions_xml.append(f"<å·²å‹ç¼©ä¿¡æ¯>\n{summary_text}\n</å·²å‹ç¼©ä¿¡æ¯>")
                continue
            
            # æ™®é€šaction
            arguments = action.get("arguments", {})
            result = action.get("result", {})
            
            # æ„å»ºå•ä¸ªåŠ¨ä½œçš„XML
            # action_xml = f"<action>\n"
            # action_xml += f"  <tool_name>{tool_name}</tool_name>\n"
            action_xml = f"action:\n"
            action_xml += f"  tool_name:{tool_name}\n"            
            # æ·»åŠ å‚æ•°
            for param_name, param_value in arguments.items():
                # è½¬ä¹‰XMLç‰¹æ®Šå­—ç¬¦
                param_value_str = str(param_value).replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")
                #action_xml += f"  <tool_use:{param_name}>{param_value_str}</tool_use:{param_name}>\n"
                action_xml += f"  {param_name}:{param_value_str}\n"
            
            # æ·»åŠ ç»“æœï¼ˆJSONæ ¼å¼ï¼‰
            try:
                result_json = json.dumps(result, ensure_ascii=False, indent=2)
                action_xml += f"  <result>\n{result_json}\n  </result>\n"
            except:
                action_xml += f"  <result>{str(result)}</result>\n"
            
            # action_xml += "</action>"
            actions_xml.append(action_xml)
        
        return "\n\n".join(actions_xml)


if __name__ == "__main__":
    # æµ‹è¯•ä¸Šä¸‹æ–‡æ„é€ å™¨
    from hierarchy_manager import HierarchyManager
    
    manager = HierarchyManager("test_task")
    manager.start_new_instruction("æµ‹è¯•ä»»åŠ¡ï¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶")
    
    agent_id = manager.push_agent("test_agent", "ç”Ÿæˆhello.pyæ–‡ä»¶")
    manager.update_thinking(agent_id, "æˆ‘éœ€è¦å…ˆåˆ›å»ºæ–‡ä»¶ï¼Œç„¶åå†™å…¥å†…å®¹")
    manager.add_action(agent_id, {
        "tool_name": "file_write",
        "arguments": {"path": "hello.py", "content": "print('hello')"},
        "result": {"status": "success", "output": "æ–‡ä»¶å·²åˆ›å»º"}
    })
    
    builder = ContextBuilder(manager)
    context = builder.build_context(agent_id, "test_agent", "ç”Ÿæˆhello.pyæ–‡ä»¶")
    
    print("=" * 80)
    print("ç”Ÿæˆçš„ä¸Šä¸‹æ–‡:")
    print("=" * 80)
    print(context)

